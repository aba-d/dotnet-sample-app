name: CD to UAT/PROD

on:
  workflow_run:
    workflows: ["ci-dev.yml"]
    types:
      - completed

permissions:
  security-events: write
  actions: read
  contents: read
  packages: write
  id-token: write

jobs:
  # ------------------------
  # Step 1️⃣ Download IMAGE_TAG artifact from CI workflow
  # ------------------------
  download-image-tag:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      IMAGE_TAG: ${{ steps.load-image-tag.outputs.IMAGE_TAG }}
    steps:
      - name: Download Docker Image Tag Artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-tag

      - name: Load Docker Image Tag
        id: load-image-tag
        run: |
          source image-tag.env
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT

  # ------------------------
  # Step 2️⃣ Deploy to QA using the IMAGE_TAG
  # ------------------------
  ecs-deploy-QA:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    needs: download-image-tag
    name: Deploy to QA
    uses: aba-enterprise/enterprise-ci-templates/.github/workflows/ecs-deployment-templatebg.yml@Feature-Deployment
    with:
      environment: "dev"
      app-language: "csharp"
      extra-env: '[{"name":"ASPNETCORE_ENVIRONMENT","value":"Development"}]'
      image-tag: ${{ needs.download-image-tag.outputs.IMAGE_TAG }}
    secrets: inherit

  # ------------------------
  # Step 3️⃣ Switch Traffic to Live
  # ------------------------
  Switch-Traffic:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    needs: ecs-deploy-QA
    name: Switch Traffic to Live
    uses: aba-enterprise/enterprise-ci-templates/.github/workflows/manual-promotion.yml@Feature-Deployment
    with:
      environment: "dev"
      temp-listener-arn: ${{ needs.ecs-deploy-QA.outputs.TEMP_LISTENER_ARN }}
      idle-tg: ${{ needs.ecs-deploy-QA.outputs.IDLE_TG }}
      idle-service: ${{ needs.ecs-deploy-QA.outputs.IDLE_SERVICE }}
      is-first-deploy: ${{ fromJSON(needs.ecs-deploy-QA.outputs.IS_FIRST_DEPLOY) }}
      live-service: ${{ needs.ecs-deploy-QA.outputs.LIVE_SERVICE}}
    secrets: inherit
