name: CD to UAT/PROD

on:
  workflow_run:
    workflows: ["CI-CD Pipeline"]
    types:
      - completed

permissions:
  security-events: write
  actions: read
  contents: read
  packages: write
  id-token: write

jobs:
  # ------------------------
  # Deploy to QA (ECS Task + Service)
  # ------------------------
 ecs-deploy-QA:
    name: Deploy to QA
    uses: aba-enterprise/enterprise-ci-templates/.github/workflows/ecs-deployment-templatebg.yml@Feature-Deployment
    with:
        environment: "dev"
        app-language: "csharp"
        extra-env: '[{\"name\":\"ASPNETCORE_ENVIRONMENT\",\"value\":\"Development\"}]'
        image-tag: ${{ needs.ci.outputs.IMAGE_TAG }}
    secrets: inherit
    
 Switch-Traffic:
    needs: ecs-deploy-QA
    name: Switch Traffic to Live
    uses: aba-enterprise/enterprise-ci-templates/.github/workflows/manual-promotion.yml@Feature-Deployment
    with:
        environment: "dev"
        temp-listener-arn: ${{ needs.ecs-deploy-dev.outputs.TEMP_LISTENER_ARN }}
        idle-tg: ${{ needs.ecs-deploy-dev.outputs.IDLE_TG }}
        idle-service: ${{ needs.ecs-deploy-dev.outputs.IDLE_SERVICE }}
        is-first-deploy: ${{ fromJSON(needs.ecs-deploy-dev.outputs.IS_FIRST_DEPLOY) }}
        live-service: ${{ needs.ecs-deploy-dev.outputs.LIVE_SERVICE}}
    secrets: inherit