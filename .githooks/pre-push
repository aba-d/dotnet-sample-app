#!/bin/sh
# Pre-push hook for DevOps reusable workflows repository
# Performs additional validation before pushing to remote
 
echo "üöÄ Running pre-push validation..."
 
# Get the range of commits being pushed
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" != "0000000000000000000000000000000000000000" ]; then
        # Check if any workflow files are being pushed
        CHANGED_WORKFLOWS=$(git diff --name-only "$remote_sha".."$local_sha" | grep -E "\.github/workflows/.*\.(yml|yaml)$" || true)
        
        if [ -n "$CHANGED_WORKFLOWS" ]; then
            echo "üìã Detected workflow changes:"
            echo "$CHANGED_WORKFLOWS"
            
            # Validate workflow file naming convention
            echo "üè∑Ô∏è  Checking workflow naming conventions..."
            for workflow in $CHANGED_WORKFLOWS; do
                filename=$(basename "$workflow")
                # Check if filename follows kebab-case convention
                if ! echo "$filename" | grep -qE "^[a-z0-9]+(-[a-z0-9]+)*\.(yml|yaml)$"; then
                    echo "‚ùå Workflow file '$filename' doesn't follow naming convention"
                    echo "   Use kebab-case: build-and-deploy.yml, security-scan.yaml, etc."
                    exit 1
                fi
            done
            
            # Check for workflow version tags or proper documentation
            echo "üìö Validating workflow documentation..."
            for workflow in $CHANGED_WORKFLOWS; do
                if ! grep -q "description:" "$workflow" && ! grep -q "# Description:" "$workflow"; then
                    echo "‚ö†Ô∏è  Workflow '$workflow' is missing description"
                    echo "   Consider adding a description for better maintainability"
                fi
            done
            
            echo "‚úÖ Workflow validation completed"
        fi
    fi
done
 
echo "üéâ Pre-push checks passed! Pushing changes..."
exit 0
